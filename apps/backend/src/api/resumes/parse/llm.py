from openai import AsyncOpenAI

from src.settings import settings

client = AsyncOpenAI(base_url="https://openrouter.ai/api/v1", api_key=settings.openrouter.token)

system_prompt = (
    """
Вы — надёжный парсер резюме. Ваша задача: из предоставленного распаршенного текста резюме извлечь строго JSON, который полностью соответствует указанной Pydantic-структуре ResumeParsedResponse и вложенным структурам (ExperienceItem, AchievementItem, AdditionalEducationItem). Важные правила — обязательно выполнять их:
Ответ должен содержать только JSON — никаких пояснений, ничего вне JSON, никаких комментариев, никакого markdown. Любой вывод, кроме валидного JSON, рассматривается как ошибка.
Структура JSON (точно эти поля, имена и типы):
role: string или null
skills: список строк или null
experience: натуральное число или null
location: строка или null
Не добавляйте дополнительные поля (например notes, confidence, raw) — только те, что в модели.
Эвристики/правила извлечения:
role: выбирайте основную должность/позицию (кратко). Если несколько ролей — выбрать наиболее релевантную/актуальную (последнюю по датам). Если неясно — null.
skills: объедините упоминаемые навыки и ключевые слова (технологии, языки, инструменты). Отфильтруйте служебные слова (например «умения», «опыт») — оставьте только конкретные навыки. Список — уникальные элементы, в нижнем регистре.
experience: стаж работы в годах
location: город, в котором проживает специалист
Ошибки разбора: если не уверены в поле — отдавайте null. Не делайте догадок по поводу чисел/дат, если нет явного указания.
Валидация вывода: JSON должен быть парсабельным; даты соответствовать шаблону или быть null; типы строго соответствовать (число/строка/массив/boolean/null).
"""  # noqa
    + f"\nОграничения: {settings.api.model_dump()}"
)

user_prompt = """
Ниже — распаршенный текст резюме %s.
Проанализируй его и верни ТОЛЬКО JSON, соответствующий ResumeParsedResponse.

Распаршенный текст:
{PARSED_RESUME_TEXT}

Пожалуйста, соблюдай все правила из system prompt (особенно формат дат, null при отсутствии данных и отсутствие любых дополнительных полей или комментариев).
"""  # noqa

text_pattern = r"\{(?:.|\n)*\}"
